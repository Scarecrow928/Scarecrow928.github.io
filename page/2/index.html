<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"scarecrow928.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="👍">
<meta property="og:url" content="https://scarecrow928.github.io/page/2/index.html">
<meta property="og:site_name" content="👍">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Scarecrow">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://scarecrow928.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>👍</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">👍</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Scarecrow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/scarecrow928" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;scarecrow928" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/thread/" class="post-title-link" itemprop="url">线程库pthread（1）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-16 11:42:45" itemprop="dateCreated datePublished" datetime="2021-06-16T11:42:45+08:00">2021-06-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><p>这部分APUE没有详细介绍，资料来自网络</p>
<h2 id="线程生命周期"><a href="#线程生命周期" class="headerlink" title="线程生命周期"></a>线程生命周期</h2><p><img src="/images/thread_lifecycle.jpg"></p>
<h2 id="进程，线程，协程"><a href="#进程，线程，协程" class="headerlink" title="进程，线程，协程"></a>进程，线程，协程</h2><ul>
<li><p>进程是资源分配的最小单位，例如全局变量、代码段、堆、栈等。</p>
</li>
<li><p>线程是系统调度的最小单位，线程之间共享进程的资源。</p>
</li>
<li><p>协程可以理解为用户层的线程，其调度不由操作系统进行而由用户应用进行，相比线程更加轻量。</p>
</li>
</ul>
<h1 id="pthread使用"><a href="#pthread使用" class="headerlink" title="pthread使用"></a>pthread使用</h1><p>编译使用了pthread的程序时，需要输入<code>cc -pthread xxx.c</code></p>
<h2 id="pthread-t"><a href="#pthread-t" class="headerlink" title="pthread_t"></a>pthread_t</h2><p>线程标识符，linux上实现为<code>unsigned long</code>，可以直接打印</p>
<h2 id="pthread-create"><a href="#pthread-create" class="headerlink" title="pthread_create"></a>pthread_create</h2><p>创建一个线程，立即开始执行，参数分别为：</p>
<ul>
<li>线程id</li>
<li>线程属性</li>
<li>任务函数</li>
<li>函数参数，可以传入结构体表示多个参数<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(<span class="keyword">pthread_t</span> *thread, <span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span> *(*start_routine) (<span class="keyword">void</span> *), <span class="keyword">void</span> *arg)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="pthread-exit"><a href="#pthread-exit" class="headerlink" title="pthread_exit"></a>pthread_exit</h2>正常退出线程，也可以在线程里返回以终止线程<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_exit</span><span class="params">(<span class="keyword">void</span> *retval)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="线程同步机制"><a href="#线程同步机制" class="headerlink" title="线程同步机制"></a>线程同步机制</h2><h3 id="pthread-mutex-t"><a href="#pthread-mutex-t" class="headerlink" title="pthread_mutex_t"></a>pthread_mutex_t</h3>互斥锁，只能有一个线程获得互斥锁，若获取不到<code>lock</code>将阻塞，<code>trylock</code>返回<code> EBUSY</code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_init</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> <span class="keyword">pthread_mutexattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果不用堆内存，可以这样初始化</span></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_trylock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="pthread-rwlock-t"><a href="#pthread-rwlock-t" class="headerlink" title="pthread_rwlock_t"></a>pthread_rwlock_t</h3><p>读写锁，读写之间互斥，写之间互斥，读之间不互斥。也有<code>trylock</code> 版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_init</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *<span class="keyword">restrict</span> rwlock,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> <span class="keyword">pthread_rwlockattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_rdlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_wrlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_unlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="pthread-cond-t"><a href="#pthread-cond-t" class="headerlink" title="pthread_cond_t"></a><font color=red>pthread_cond_t</font></h3><p>条件变量，有点类似进程控制中的<code>sigsuspend</code>，等待特定信号到达后继续运行。发送信号可以单播也可以广播</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_init</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">pthread_condattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程开始等待条件到达</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_wait</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送信号，唤醒等待条件的线程</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_signal</span><span class="params">(<span class="keyword">pthread_cond_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_broadcast</span><span class="params">(<span class="keyword">pthread_cond_t</span> *cond)</span></span>;</span><br></pre></td></tr></table></figure>

<p>条件变量需要用<code>mutex</code>保护，一个模板写法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局mutex，用于同步各线程，保护条件</span></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我是否可以行动的条件</span></span><br><span class="line"><span class="keyword">pthread_cond_t</span> cond; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 模板 </span></span><br><span class="line">pthread_mutex_lock(&amp;mutex);</span><br><span class="line"><span class="keyword">while</span> (<span class="comment">/* 条件没达成吗 */</span>)</span><br><span class="line">    pthread_cond_wait(&amp;cond, &amp;mutex);</span><br><span class="line"><span class="comment">/* 临界区代码在此 */</span></span><br><span class="line">pthread_mutex_unlock(&amp;mutex);</span><br><span class="line"><span class="comment">// 非临界区</span></span><br></pre></td></tr></table></figure>
<p>这是一个等待条件的线程的模板，当线程发现还没轮到它运行，会挂起，直到有一个其他线程发出了<code>pthread_cond_signal(&amp;cond)</code>，并且<code>mutex</code>可以获取，线程才能从<code>pthread_cond_wait</code>返回。</p>
<p>这种方式避免了使用自旋锁。若使用自旋锁，CPU会因为重复判断条件而一直处于高负荷状态，对系统整体效率影响很大。</p>
<h3 id="pthread-barrier-t"><a href="#pthread-barrier-t" class="headerlink" title="pthread_barrier_t"></a>pthread_barrier_t</h3><p>屏障，必须在指定个数线程到达屏障后，这些线程才能继续运行，<code>count</code>表示线程数</p>
<p>注意，屏障可以重复使用，每次都会等待<code>count</code>个线程到达后放行，不需要重复初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_barrier_init</span><span class="params">(<span class="keyword">pthread_barrier_t</span> *<span class="keyword">restrict</span> barrier,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">pthread_barrierattr_t</span> *<span class="keyword">restrict</span> attr, <span class="keyword">unsigned</span> count)</span></span>;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/signal2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/signal2/" class="post-title-link" itemprop="url">信号机制（2）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-15 12:22:09" itemprop="dateCreated datePublished" datetime="2021-06-15T12:22:09+08:00">2021-06-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="可重入函数"><a href="#可重入函数" class="headerlink" title="可重入函数"></a>可重入函数</h1><p>某些库函数中调用了<code>malloc</code>等函数，若在其调用期间被信号中断，可能引起内存分配错误。</p>
<p>可重入函数是异步信号安全的，它们调用时会阻塞信号，不会引起因信号产生的安全问题。</p>
<h1 id="signal相关函数"><a href="#signal相关函数" class="headerlink" title="signal相关函数"></a>signal相关函数</h1><h2 id="sigaction"><a href="#sigaction" class="headerlink" title="sigaction"></a>sigaction</h2><p>检查、修改某个信号的动作，<code>act</code>为新动作，可为<code>NULL</code>；<code>oldact</code>为已存在动作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigaction</span><span class="params">(<span class="keyword">int</span> signum, <span class="keyword">const</span> struct sigaction *act,</span></span></span><br><span class="line"><span class="params"><span class="function">                struct sigaction *oldact)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>     (*sa_handler)(<span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">void</span>     (*sa_sigaction)(<span class="keyword">int</span>, <span class="keyword">siginfo_t</span> *, <span class="keyword">void</span> *);</span><br><span class="line">    <span class="keyword">sigset_t</span>   sa_mask;</span><br><span class="line">    <span class="keyword">int</span>        sa_flags;</span><br><span class="line">    <span class="keyword">void</span>     (*sa_restorer)(<span class="keyword">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="setjmp-longjmp-与-sigsetjmp-siglongjmp"><a href="#setjmp-longjmp-与-sigsetjmp-siglongjmp" class="headerlink" title="setjmp longjmp 与 sigsetjmp siglongjmp"></a>setjmp longjmp 与 sigsetjmp siglongjmp</h2><p>这几个函数都用于非本地跳转，类似<code>goto</code>。<code>long</code>处的函数调用后，会从<code>set</code>处返回。</p>
<p><code>setjmp longjmp</code>不恢复信号屏蔽字，而<code>sigsetjmp siglongjmp</code>在<code>set</code>处先保存当前信号屏蔽字，<code>long</code>回来时，恢复之前保存的屏蔽字。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setjmp</span><span class="params">(jmp_buf env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigsetjmp</span><span class="params">(sigjmp_buf env, <span class="keyword">int</span> savesigs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">longjmp</span><span class="params">(jmp_buf env, <span class="keyword">int</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">siglongjmp</span><span class="params">(sigjmp_buf env, <span class="keyword">int</span> val)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="sigsuspend"><a href="#sigsuspend" class="headerlink" title="sigsuspend"></a>sigsuspend</h2><p>原子操作，保存当前信号屏蔽字，设置信号屏蔽字<code>mask</code>后<code>pause</code>，在接收到信号并处理好后，恢复保存的屏蔽字再返回。它不存在临界区内收到信号的问题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigsuspend</span><span class="params">(<span class="keyword">const</span> <span class="keyword">sigset_t</span> *mask)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="system"><a href="#system" class="headerlink" title="system"></a>system</h2><p>执行shell命令，注意<code>system</code>的返回值<font color=red><strong>不一定</strong></font>是命令返回值，其实返回值是shell返回值，在shell异常退出时，会返回<code>128 + 信号值</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/signal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/signal/" class="post-title-link" itemprop="url">信号机制（1）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-12 08:53:49" itemprop="dateCreated datePublished" datetime="2021-06-12T08:53:49+08:00">2021-06-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="信号机制"><a href="#信号机制" class="headerlink" title="信号机制"></a>信号机制</h1><p>信号用于处理异步事件，例如用户输入<code>ctrl + c</code>，调用<code>kill</code>杀死一个进程等</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><h3 id="生成信号"><a href="#生成信号" class="headerlink" title="生成信号"></a>生成信号</h3><p>生成信号的方法有许多种：</p>
<ul>
<li>用户在终端输入，例如<code>ctrl + c</code>向前台进程发送<code>SIGINT</code></li>
<li>硬件异常，由内核产生信号，例如无效内存访问<code>SIGSEGV</code></li>
<li><code>kill(1)</code>命令与<code>kill(2)</code>函数，在权限允许情况下可以向其他进程发送任意信号</li>
<li>某些软件条件达成</li>
</ul>
<h3 id="接收与处理信号"><a href="#接收与处理信号" class="headerlink" title="接收与处理信号"></a>接收与处理信号</h3><p>进程收到信号时，必须选择以下三个行为之一：</p>
<ul>
<li>忽略信号。例如通过<code>signal</code>函数注册忽略<code>SIGINT</code>：<code>signal(SIGINT, SIG_IGN);</code></li>
<li>捕获信号。需要通过<code>signal</code>函数注册，可自定义处理行为</li>
<li>默认动作。不注册行为，则在收到信号时执行系统默认动作。查看系统默认行为，Linux：<code>man 7 signal</code>，FreeBSD：<code>man signal</code></li>
</ul>
<p>有两个不能忽略也不能捕获的信号：</p>
<ul>
<li><code>SIGKILL</code>：直接杀死进程，进程无法选择安全退出，不能继续运行</li>
<li><code>SIGSTOP</code>：停止运行进程，收到<code>SIGCONT</code>后继续运行</li>
</ul>
<h2 id="signal函数"><a href="#signal函数" class="headerlink" title="signal函数"></a><code>signal</code>函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Linux</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="keyword">sighandler_t</span>)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">sighandler_t</span> <span class="title">signal</span><span class="params">(<span class="keyword">int</span> signum, <span class="keyword">sighandler_t</span> handler)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FreeBSD中的定义相同，不过属于库函数，而Linux中属于系统调用</span></span><br></pre></td></tr></table></figure>
<p>这个复杂的定义，有两行：</p>
<ol>
<li><code>typedef</code>定义了<code>sighandler_t</code>类型，它是：<ul>
<li>一个函数指针类型</li>
<li>它指向的函数返回<code>void</code>，有一个参数<code>int</code></li>
</ul>
</li>
<li>下一行定义了<code>signal</code>函数：<ul>
<li>返回<code>sighandler_t</code>类型，它就是传入的第二个参数，或者<code>SIG_ERR</code></li>
<li>两个参数，<code>int signum</code>代表希望处理的信号，<code>sighandler_t handler</code>是自定义的信号处理函数，这个函数必须是返回<code>void</code>，参数<code>int</code></li>
</ul>
</li>
</ol>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p><code>kill</code>命令默认会发出<code>SIGTERM</code>信号，如果不注册处理函数，则系统默认行为是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15  SIGTERM  terminate process    software termination signal</span><br></pre></td></tr></table></figure>

<p>一般情况下，用<code>kill</code>杀死进程的过程如下：</p>
<ol>
<li><code>kill</code>向指定进程发出<code>SIGTERM</code></li>
<li>进程接受到信号，寻找信号处理函数</li>
<li>执行系统默认行为，终止进程</li>
</ol>
<p>如果捕获了<code>SIGTERM</code>，则可以在进程停止前进行保存工作，安全退出，甚至可以选择不退出，但这不符合<code>SIGTERM</code>的意义。</p>
<p>代码的含义是：进程在接受到两次<code>SIGTERM</code>后，才正常退出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> c = <span class="number">2</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sigterm_handler</span><span class="params">(<span class="keyword">int</span> signo)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;handle signal: %d\n&quot;</span>, signo);</span><br><span class="line">    c--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    signal(SIGTERM, &amp;sigterm_handler);</span><br><span class="line">    <span class="keyword">while</span> (c &gt; <span class="number">0</span>)</span><br><span class="line">        pause();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让进程后台运行，通过<code>kill</code>发送两次<code>SIGTERM</code>，等待其正常退出</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> ./a.out &amp;</span><br><span class="line">[<span class="number">1</span>] <span class="number">2587</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">kill</span> <span class="number">2587</span></span><br><span class="line"><span class="variable">$</span> handle signal: <span class="number">15</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> <span class="built_in">kill</span> <span class="number">2587</span></span><br><span class="line">handle signal: <span class="number">15</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line"><span class="variable">$</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/fork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/fork/" class="post-title-link" itemprop="url">fork exec</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-09 03:34:58" itemprop="dateCreated datePublished" datetime="2021-06-09T03:34:58+08:00">2021-06-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="fork"><a href="#fork" class="headerlink" title="fork"></a><code>fork</code></h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Linux</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">fork</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="父进程与子进程的关系"><a href="#父进程与子进程的关系" class="headerlink" title="父进程与子进程的关系"></a>父进程与子进程的关系</h2><ol>
<li><code>fork</code>函数父进程返回子进程pid，子进程返回<code>0</code></li>
<li>父进程与子进程的全局变量不共享。出于效率，变量是“写时复制”的，父子任意进程写入变量前，创建存储区副本</li>
<li>父进程与子进程的文件描述符也是复制的，在父进程打开文件后<code>fork</code>，则子进程也已打开了文件，需要同步措施防止它们同时读写文件</li>
<li>子进程继承了实际id、有效id，工作目录等等</li>
</ol>
<h1 id="exec"><a href="#exec" class="headerlink" title="exec"></a><code>exec</code></h1><h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> **environ;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execl</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">const</span> <span class="keyword">char</span> *arg, ...</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="comment">/* (char  *) NULL */</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execlp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">const</span> <span class="keyword">char</span> *arg, ...</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="comment">/* (char  *) NULL */</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execle</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">const</span> <span class="keyword">char</span> *arg, ...</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="comment">/*, (char *) NULL, char *const envp[] */</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">char</span> *<span class="keyword">const</span> argv[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execvp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">char</span> *<span class="keyword">const</span> argv[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execvpe</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">char</span> *<span class="keyword">const</span> argv[],</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">char</span> *<span class="keyword">const</span> envp[])</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ol>
<li><code>pathname</code>为路径名，绝对相对均可；<code>file</code>为文件名，若含<code>&quot;/&quot;</code>字符，视为文件名，否则在<code>PATH</code>环境变量中路径搜索可执行文件或shell脚本</li>
<li>与<code>fork</code>不同，<code>exec</code>并不产生新进程，它将原始进程的代码段、全局变量数据段、堆、栈替换为新进程，新进程<code>pid</code>并不会改变</li>
</ol>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t18.c，可执行文件为mypid，由exec启动这个进程</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;my pid: %d\n&quot;</span>, getpid());</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// t19.c，原始进程，将启动./mypid</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;before exec, my pid: %d\n&quot;</span>, getpid());</span><br><span class="line">    execl(<span class="string">&quot;./mypid&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this line\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译，运行：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> cc t18.c <span class="literal">-o</span> mypid</span><br><span class="line"><span class="variable">$</span> cc t19.c</span><br><span class="line"><span class="variable">$</span> ./a.out </span><br><span class="line">before exec, my pid: <span class="number">1520</span></span><br><span class="line">my pid: <span class="number">1520</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/malloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/malloc/" class="post-title-link" itemprop="url">malloc calloc realloc</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-08 06:48:38" itemprop="dateCreated datePublished" datetime="2021-06-08T06:48:38+08:00">2021-06-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Linux</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">calloc</span><span class="params">(<span class="keyword">size_t</span> nmemb, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">realloc</span><span class="params">(<span class="keyword">void</span> *ptr, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FreeBSD</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc_np.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">calloc</span><span class="params">(<span class="keyword">size_t</span> number, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">realloc</span><span class="params">(<span class="keyword">void</span> *ptr, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span><br></pre></td></tr></table></figure>
<h1 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h1><h2 id="函数之间的区别"><a href="#函数之间的区别" class="headerlink" title="函数之间的区别"></a>函数之间的区别</h2><ol>
<li><code>malloc</code>申请的区域值不被初始化，而<code>calloc</code>会将其初始化为<code>0</code></li>
<li><code>malloc</code>输入为需要的字节数，<code>calloc</code>输入为对象数<code>nmemb</code>与每个对象字节数<code>size</code></li>
<li><code>realloc</code>为已分配的地址重新分配大小，可增可减</li>
</ol>
<p>三个函数均通过系统调用<code>sbrk</code>实现。</p>
<h2 id="malloc与new运算符的区别"><a href="#malloc与new运算符的区别" class="headerlink" title="malloc与new运算符的区别"></a><code>malloc</code>与<code>new</code>运算符的区别</h2><ol>
<li><code>malloc</code>是<code>stdlib.h</code>中的库函数，而<code>new</code>是C++运算符</li>
<li><code>malloc</code>需要指定所需字节数，<code>new</code>则由编译器推算，无需指定大小</li>
<li><code>malloc</code>返回<code>void *</code>，后续需要自己转换类型，<code>new</code>则直接返回申请对象类型的指针</li>
<li><code>malloc</code>申请失败时返回<code>NULL</code>，<code>new</code>则会抛出异常<code>std::bad_alloc</code></li>
<li><code>malloc</code>直接在堆上分配内存，<code>new</code>则在自由存储区上分配。大部分编译器用堆实现自由存储区。堆是操作系统维护的内存区域，而自由存储区是C++概念</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/segment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/segment/" class="post-title-link" itemprop="url">C程序中的存储空间布局</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-05 08:19:32" itemprop="dateCreated datePublished" datetime="2021-06-05T08:19:32+08:00">2021-06-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="C程序中的存储空间布局"><a href="#C程序中的存储空间布局" class="headerlink" title="C程序中的存储空间布局"></a>C程序中的存储空间布局</h1><p>从内存高地址到低地址，可分为：</p>
<ul>
<li>栈</li>
<li>堆</li>
<li>未初始化数据段</li>
<li>初始化数据段</li>
<li>正文段</li>
</ul>
<h2 id="正文段"><a href="#正文段" class="headerlink" title="正文段"></a>正文段</h2><ol>
<li>主要内容为机器指令</li>
<li>只读</li>
<li>只需要一个副本，多次执行共享</li>
</ol>
<h2 id="初始化数据段"><a href="#初始化数据段" class="headerlink" title="初始化数据段"></a>初始化数据段</h2><ol>
<li>全局变量</li>
<li>内核在程序开始执行之前从文件读取值为其初始化</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h2 id="未初始化数据段（Block-Started-by-Symbol-BSS）"><a href="#未初始化数据段（Block-Started-by-Symbol-BSS）" class="headerlink" title="未初始化数据段（Block Started by Symbol, BSS）"></a>未初始化数据段（Block Started by Symbol, BSS）</h2><ol>
<li>全局变量</li>
<li>内核在程序开始执行之前将其初始化为<code>0</code>或<code>NULL</code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a[<span class="number">100</span>];</span><br></pre></td></tr></table></figure>
注意指针<code>a</code>是已初始化的，而<code>a</code>数组的内容是未初始化的，一般内核将<code>a</code>数组内容置为全<code>0</code></li>
</ol>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><ol>
<li>动态内存分配的变量</li>
</ol>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><ol>
<li>局部变量</li>
<li>函数调用时保存的上下文</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/link/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/link/" class="post-title-link" itemprop="url">软链接与硬链接的区别</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-03 03:21:35" itemprop="dateCreated datePublished" datetime="2021-06-03T03:21:35+08:00">2021-06-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>软链接中的实际内容为指向文件的路径，而硬链接中包含原始文件的索引节点（inode）。也就是：软链接的inode与原始文件不同，而硬链接的inode与原始文件相同。</p>
<p>当访问软链接时，需要通过文件中的路径来访问原始文件，而硬链接直接通过inode访问即可。</p>
<p>在删除原始文件后，其硬链接链接计数器会减1，若减至0则删除文件数据块。软链接中指向路径不会发生变化，而原始文件路径已经不存在了，所以再次访问软链接会报错<code>No such file or directory</code>，而硬链接因为在创建时，向原始文件的硬链接计数器<code>st_nlink</code>加1了，因此删除原始文件也只是使其减1，并没有删除数据块，硬链接仍然能访问原始数据块。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">    <span class="keyword">dev_t</span>     st_dev;         <span class="comment">/* ID of device containing file */</span></span><br><span class="line">    <span class="keyword">ino_t</span>     st_ino;         <span class="comment">/* Inode number */</span></span><br><span class="line">    <span class="keyword">mode_t</span>    st_mode;        <span class="comment">/* File type and mode */</span></span><br><span class="line">    <span class="keyword">nlink_t</span>   st_nlink;       <span class="comment">/* Number of hard links 硬链接计数器在这里 */</span> </span><br><span class="line">    <span class="keyword">uid_t</span>     st_uid;         <span class="comment">/* User ID of owner */</span></span><br><span class="line">    <span class="keyword">gid_t</span>     st_gid;         <span class="comment">/* Group ID of owner */</span></span><br><span class="line">    <span class="keyword">dev_t</span>     st_rdev;        <span class="comment">/* Device ID (if special file) */</span></span><br><span class="line">    <span class="keyword">off_t</span>     st_size;        <span class="comment">/* Total size, in bytes */</span></span><br><span class="line">    <span class="keyword">blksize_t</span> st_blksize;     <span class="comment">/* Block size for filesystem I/O */</span></span><br><span class="line">    <span class="keyword">blkcnt_t</span>  st_blocks;      <span class="comment">/* Number of 512B blocks allocated */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_atim</span>;</span>  <span class="comment">/* Time of last access */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_mtim</span>;</span>  <span class="comment">/* Time of last modification */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_ctim</span>;</span>  <span class="comment">/* Time of last status change */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在shell中测试删除效果</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="built_in">echo</span> <span class="string">&quot;something&quot;</span> &gt; <span class="keyword">data</span></span><br><span class="line"><span class="variable">$</span> ln <span class="keyword">data</span> hardlink_data <span class="comment"># 硬链接</span></span><br><span class="line"><span class="variable">$</span> ln <span class="literal">-s</span> <span class="keyword">data</span> softlink_data <span class="comment"># 软链接</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># data的inode值与hardlink_data值相同，links = 2</span></span><br><span class="line"><span class="variable">$</span> stat <span class="keyword">data</span></span><br><span class="line">  File: <span class="keyword">data</span></span><br><span class="line">  Size: <span class="number">10</span>              Blocks: <span class="number">8</span>          IO Block: <span class="number">4096</span>   regular file</span><br><span class="line">Device: <span class="number">830</span><span class="built_in">h</span>/<span class="number">2096</span>d      Inode: <span class="number">11481</span>       Links: <span class="number">2</span></span><br><span class="line">Access: (<span class="number">0644</span>/<span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>--)  Uid: ( <span class="number">1000</span>/scarecrow)   Gid: ( <span class="number">1000</span>/scarecrow)</span><br><span class="line">Access: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">38.998538700</span> +<span class="number">0800</span></span><br><span class="line">Modify: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">38.998538700</span> +<span class="number">0800</span></span><br><span class="line">Change: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">27.628538700</span> +<span class="number">0800</span></span><br><span class="line"> Birth: -</span><br><span class="line"><span class="variable">$</span> stat hardlink_data</span><br><span class="line">  File: hardlink_data</span><br><span class="line">  Size: <span class="number">10</span>              Blocks: <span class="number">8</span>          IO Block: <span class="number">4096</span>   regular file</span><br><span class="line">Device: <span class="number">830</span><span class="built_in">h</span>/<span class="number">2096</span>d      Inode: <span class="number">11481</span>       Links: <span class="number">2</span></span><br><span class="line">Access: (<span class="number">0644</span>/<span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>--)  Uid: ( <span class="number">1000</span>/scarecrow)   Gid: ( <span class="number">1000</span>/scarecrow)</span><br><span class="line">Access: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">38.998538700</span> +<span class="number">0800</span></span><br><span class="line">Modify: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">38.998538700</span> +<span class="number">0800</span></span><br><span class="line">Change: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">27.628538700</span> +<span class="number">0800</span></span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line"> <span class="comment"># softlink_data的inode值与data不同</span></span><br><span class="line"> <span class="variable">$</span> stat softlink_data</span><br><span class="line">  File: softlink_data -&gt; <span class="keyword">data</span></span><br><span class="line">  Size: <span class="number">4</span>               Blocks: <span class="number">0</span>          IO Block: <span class="number">4096</span>   symbolic link</span><br><span class="line">Device: <span class="number">830</span><span class="built_in">h</span>/<span class="number">2096</span>d      Inode: <span class="number">42305</span>       Links: <span class="number">1</span></span><br><span class="line">Access: (<span class="number">0777</span>/lrwxrwxrwx)  Uid: ( <span class="number">1000</span>/scarecrow)   Gid: ( <span class="number">1000</span>/scarecrow)</span><br><span class="line">Access: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">59.968538700</span> +<span class="number">0800</span></span><br><span class="line">Modify: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">42.768538700</span> +<span class="number">0800</span></span><br><span class="line">Change: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">42.768538700</span> +<span class="number">0800</span></span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line"> <span class="variable">$</span> <span class="built_in">rm</span> <span class="keyword">data</span></span><br><span class="line"> <span class="variable">$</span> <span class="built_in">cat</span> softlink_data</span><br><span class="line"><span class="built_in">cat</span>: softlink_data: No such file or directory</span><br><span class="line"><span class="variable">$</span> <span class="built_in">cat</span> hardlink_data</span><br><span class="line">something</span><br><span class="line"></span><br><span class="line"><span class="comment"># links 减至1了</span></span><br><span class="line"><span class="variable">$</span> stat hardlink_data</span><br><span class="line">  File: hardlink_data</span><br><span class="line">  Size: <span class="number">10</span>              Blocks: <span class="number">8</span>          IO Block: <span class="number">4096</span>   regular file</span><br><span class="line">Device: <span class="number">830</span><span class="built_in">h</span>/<span class="number">2096</span>d      Inode: <span class="number">11481</span>       Links: <span class="number">1</span></span><br><span class="line">Access: (<span class="number">0644</span>/<span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>--)  Uid: ( <span class="number">1000</span>/scarecrow)   Gid: ( <span class="number">1000</span>/scarecrow)</span><br><span class="line">Access: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">47</span>:<span class="number">07.268538700</span> +<span class="number">0800</span></span><br><span class="line">Modify: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">38.998538700</span> +<span class="number">0800</span></span><br><span class="line">Change: <span class="number">2021</span><span class="literal">-06</span><span class="literal">-03</span> <span class="number">11</span>:<span class="number">46</span>:<span class="number">50.228538700</span> +<span class="number">0800</span></span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/access/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/access/" class="post-title-link" itemprop="url">access open的区别</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-31 17:47:51" itemprop="dateCreated datePublished" datetime="2021-05-31T17:47:51+08:00">2021-05-31</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="access-open的区别"><a href="#access-open的区别" class="headerlink" title="access open的区别"></a>access open的区别</h1><p>摘自<em>Linux Programmer’s Manual</em>中access函数DESCRIPTION节</p>
<blockquote>
<p>The  check is done using the calling process’s <font size=4 color=red><strong>real UID and GID</strong></font>, rather than the effective IDs as is done when<br>actually attempting an operation (e.g., open(2)) on the file.  Similarly, for the root user,  the  check  uses<br>the  set  of permitted capabilities rather than the set of effective capabilities; and for non-root users, the<br>check uses an empty set of capabilities.</p>
</blockquote>
<p>可以看到<code>access</code>系统调用在检测进程对文件的访问权限时，使用的是进程实际用户id和组id。而<code>open</code>系统调用使用的是有效id，大部分情况下它们的表现没有区别，而若有效id与实际id不同时，则会出现访问权限区别。</p>
<p>APUE书中给了一个例子，略作修改后如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 通过实际id访问文件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == access(<span class="string">&quot;file.txt&quot;</span>, R_OK))</span><br><span class="line">        perror(<span class="string">&quot;access&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;access成功\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过有效id访问文件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == open(<span class="string">&quot;file.txt&quot;</span>, O_RDONLY))</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open读成功\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在shell中测试它的行为</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译完成的后的文件为a.out，目录下存在一个file.txt文件用于测试</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> <span class="built_in">ls</span> <span class="literal">-l</span> file.txt</span><br><span class="line"><span class="literal">-r</span>-------- <span class="number">1</span> root root <span class="number">0</span> Jun  <span class="number">1</span>  <span class="number">2021</span> file.txt</span><br><span class="line"><span class="comment"># file.txt文件属于root用户，仅root拥有读权限</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> <span class="built_in">ls</span> <span class="literal">-l</span> a.out</span><br><span class="line"><span class="literal">-rwxr</span><span class="literal">-xr</span><span class="literal">-x</span> <span class="number">1</span> root root <span class="number">16864</span> Jun  <span class="number">1</span>  <span class="number">2021</span> a.out</span><br><span class="line"><span class="comment"># a.out可执行文件属于root用户，所有用户均可执行它</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> ./a.out</span><br><span class="line">access: Permission denied</span><br><span class="line">open: Permission denied</span><br><span class="line"><span class="comment"># 以普通用户身份执行a.out，access open均无法访问file.txt</span></span><br><span class="line"><span class="comment"># 因为此时进程的 有效id、实际id 均为 &quot;scarecrow&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> sudo chmod u+s a.out</span><br><span class="line"><span class="variable">$</span> <span class="built_in">ls</span> <span class="literal">-l</span> a.out</span><br><span class="line"><span class="literal">-rwsr</span><span class="literal">-xr</span><span class="literal">-x</span> <span class="number">1</span> root root <span class="number">16864</span> Jun  <span class="number">1</span>  <span class="number">2021</span> a.out</span><br><span class="line"><span class="comment"># 给a.out设置上&quot;S_ISUID&quot;位，在执行a.out时，有效id会被设置成a.out的所有者，本例中为root</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> ./a.out</span><br><span class="line">access: Permission denied</span><br><span class="line">open读成功</span><br><span class="line"><span class="comment"># access 使用实际id (scarecrow) 访问，依然无法读取</span></span><br><span class="line"><span class="comment"># open 使用有效id (root) 访问，能读取</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/stat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/stat/" class="post-title-link" itemprop="url">unix文件访问权限，stat fstat lstat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-31 03:46:59" itemprop="dateCreated datePublished" datetime="2021-05-31T03:46:59+08:00">2021-05-31</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="实际用户id-有效用户id-保存的设置用户id"><a href="#实际用户id-有效用户id-保存的设置用户id" class="headerlink" title="实际用户id 有效用户id 保存的设置用户id"></a>实际用户id 有效用户id 保存的设置用户id</h1><p>与进程关联的id有至少6个：</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">read id</td>
<td align="center">实际用户id，进程的运行者</td>
</tr>
<tr>
<td align="center">read group id</td>
<td align="center">实际组id，进程的运行者所在组</td>
</tr>
<tr>
<td align="center">effective user id</td>
<td align="center">有效用户id，进程文件访问权限</td>
</tr>
<tr>
<td align="center">effective group id</td>
<td align="center">有效组id，进程文件访问权限</td>
</tr>
<tr>
<td align="center">saved user id</td>
<td align="center">有效用户id的副本</td>
</tr>
<tr>
<td align="center">saved group id</td>
<td align="center">有效组id的副本</td>
</tr>
</tbody></table>
<p>通常实际id不会改变，有效id等于实际id，但在某些情况下可能有效id会改变，例如运行<code>passwd</code>。</p>
<h2 id="保存的设置用户id"><a href="#保存的设置用户id" class="headerlink" title="保存的设置用户id"></a>保存的设置用户id</h2><p>某些程序，例如<code>at</code>，普通用户能够执行<code>at</code>，但<code>at</code>有时需要超级用户权限，有时候则必须以普通用户权限运行。保存的设置用户id在这时发挥效果，它可以用来判断<code>at</code>是否能将其有效用户id设置为超级用户。</p>
<p><code>at</code>的所有者是超级用户<code>root</code>，并且其文件权限设置了<code>setuid</code>位，因此普通用户它运行它时：</p>
<ul>
<li>实际用户id：普通用户</li>
<li>有效用户id：root</li>
<li>保存的设置用户id：root</li>
</ul>
<p>在需要降低权限时：</p>
<ul>
<li>实际用户id：普通用户</li>
<li>有效用户id：普通用户</li>
<li>保存的设置用户id：root</li>
</ul>
<p>需要恢复特权时，保存的设置用户id指出，这个进程是能够恢复成<code>root</code>的，因为它的保存的设置用户id等于<code>root</code>！<code>seteuid</code>函数允许输入的<code>uid</code>等于保存的设置用户id，或者实际用户id：</p>
<ul>
<li>实际用户id：普通用户</li>
<li>有效用户id：root，能够设置！</li>
<li>保存的设置用户id：root</li>
</ul>
<h1 id="文件访问权限"><a href="#文件访问权限" class="headerlink" title="文件访问权限"></a>文件访问权限</h1><p>每个文件有9个访问权限位，从左至右：</p>
<table>
<thead>
<tr>
<th align="center">st_mode掩码</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">S_IRUSR</td>
<td align="center">拥有者读</td>
</tr>
<tr>
<td align="center">S_IWUSR</td>
<td align="center">拥有者写</td>
</tr>
<tr>
<td align="center">S_IXUSR</td>
<td align="center">拥有者执行</td>
</tr>
<tr>
<td align="center">S_IRGRP</td>
<td align="center">组内用户读</td>
</tr>
<tr>
<td align="center">S_IWGRP</td>
<td align="center">组内用户写</td>
</tr>
<tr>
<td align="center">S_IXGRP</td>
<td align="center">组内用户执行</td>
</tr>
<tr>
<td align="center">S_IROTH</td>
<td align="center">其他用户读</td>
</tr>
<tr>
<td align="center">S_IWOTH</td>
<td align="center">其他用户写</td>
</tr>
<tr>
<td align="center">S_IXOTH</td>
<td align="center">其他用户执行</td>
</tr>
</tbody></table>
<p>另外包含3位特殊位，在<code>ls -l</code>中不显示，从左至右为：</p>
<table>
<thead>
<tr>
<th align="center">st_mode掩码</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">S_ISUID</td>
<td align="center">执行时设置有效用户id位为拥有者</td>
</tr>
<tr>
<td align="center">S_ISGID</td>
<td align="center">执行时设置有效组id位为拥有者所在组</td>
</tr>
<tr>
<td align="center">S_ISVTX</td>
<td align="center">拥有者才能删除、重命名</td>
</tr>
</tbody></table>
<p>由于<code>/usr/bin/passwd</code>在运行时能够修改用户密码等内容，也就是修改<code>/etc/passwd</code>中内容，但是<code>/etc/passwd</code>只有<code>root</code>用户才能修改。因此普通用户若需要运行<code>passwd</code>命令，就需要将<code>effective id</code>设为超级用户，于是<code>/usr/bin/passwd</code>文件设置了<code>S_ISUID</code>位：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ stat /usr/bin/passwd</span><br><span class="line">  File: /usr/bin/passwd</span><br><span class="line">  Size: 68208           Blocks: 136        IO Block: 4096   regular file</span><br><span class="line">Device: 830h/2096d      Inode: 2102        Links: 1</span><br><span class="line">Access: (4755/-rwsr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2021-03-25 15:43:40.040000000 +0800</span><br><span class="line">Modify: 2020-05-28 14:37:47.000000000 +0800</span><br><span class="line">Change: 2021-03-25 15:43:25.060000000 +0800</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>

<p>注意<code>Access: (4755/-rwsr-xr-x)</code>，<code>4755</code>二进制表示为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 111 101 101</span><br></pre></td></tr></table></figure>
<p>左边3位对应特殊位，右边9位为读写执行权限位，passwd程序<code>S_ISUID = 1</code></p>
<h1 id="stat-fstat-lstat"><a href="#stat-fstat-lstat" class="headerlink" title="stat fstat lstat"></a>stat fstat lstat</h1><p><code>man 2 stat</code>中对这三个函数定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stat</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, struct stat *statbuf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fstat</span><span class="params">(<span class="keyword">int</span> fd, struct stat *statbuf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lstat</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, struct stat *statbuf)</span></span>;</span><br></pre></td></tr></table></figure>
<p>关于<code>struct stat</code>结构体可以直接运行<code>man 2 stat</code>查看。三个函数可用于查看文件属性，查询结果保存于<code>statbuff</code>中，<code>stat</code>与<code>lstat</code>的区别在于<code>lstat</code>不会解析链接而<code>stat</code>会。</p>
<p>放一个用<code>fstat</code>查看<code>/usr/bin/passwd</code>的设置有效用户id位代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>             fd_passwd = open(<span class="string">&quot;/usr/bin/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span>     <span class="title">stat_passwd</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == fstat(fd_passwd, &amp;stat_passwd)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;fstat /usr/bin/passwd error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;/usr/bin/passwd st_mode: %x, S_ISUID: %x\n&quot;</span>, </span><br><span class="line">        stat_passwd.st_mode, S_ISUID);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;/usr/bin/passwd st_uid: %s\n&quot;</span>, </span><br><span class="line">        (stat_passwd.st_mode &amp; S_ISUID) ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out </span><br><span class="line">/usr/bin/passwd st_mode: 89ed, S_ISUID: 800</span><br><span class="line">/usr/bin/passwd st_uid: true</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scarecrow928.github.io/apue/post2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Scarecrow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="👍">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/apue/post2/" class="post-title-link" itemprop="url">open openat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-29 03:05:33" itemprop="dateCreated datePublished" datetime="2021-05-29T03:05:33+08:00">2021-05-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-09 10:50:48" itemprop="dateModified" datetime="2021-12-09T10:50:48+08:00">2021-12-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/apue/" itemprop="url" rel="index"><span itemprop="name">apue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>包含于<code>fcntl.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// open通过绝对路径或当前目录的相对路径打开文件，返回fd</span></span><br><span class="line">open(<span class="keyword">const</span> <span class="keyword">char</span> *__path, <span class="keyword">int</span> __oflag, ...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// openat 可以将__fd视为当前目录，__path为相对路径，也可令__fd = AT_FDCWD 使其为当前目录</span></span><br><span class="line"><span class="comment">// 若__path是绝对路径，__fd无效</span></span><br><span class="line">openat(<span class="keyword">int</span> __fd, <span class="keyword">const</span> <span class="keyword">char</span> *__path, <span class="keyword">int</span> __oflag, ...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两个函数出错均返回-1，errno设为错误值</span></span><br></pre></td></tr></table></figure>

<p>使用例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 推荐buf大小为4096字节，因为ext4文件系统中一个块大小为4096字节</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_BUFSIZE 256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dir_fd = open(<span class="string">&quot;.&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (dir_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dir open failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> data_fd = openat(dir_fd, <span class="string">&quot;data.txt&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (data_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;data.txt open failed&quot;</span>);</span><br><span class="line">        close(dir_fd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dir_fd: %d, data_fd: %d\n&quot;</span>, dir_fd, data_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[READ_BUFSIZE];</span><br><span class="line">    <span class="keyword">ssize_t</span> bytes, total = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((bytes = read(data_fd, buf, READ_BUFSIZE)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;byted read: %d\n&quot;</span>, (<span class="keyword">int</span>)bytes);</span><br><span class="line">        total += bytes;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    close(data_fd);</span><br><span class="line">    close(dir_fd);</span><br><span class="line">    <span class="keyword">if</span> (bytes == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;read from data.txt: %d bytes\n&quot;</span>, (<span class="keyword">int</span>)total);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> not_exist_fd = openat(AT_FDCWD, <span class="string">&quot;no_such_file.txt&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (not_exist_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open \&quot;no_such_file.txt\&quot;&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        close(not_exist_fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out</span><br><span class="line">dir_fd: 3, data_fd: 4</span><br><span class="line">byted read: 256</span><br><span class="line">byted read: 97</span><br><span class="line">read from data.txt: 353 bytes</span><br><span class="line">open &quot;no_such_file.txt&quot;: No such file or directory</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Scarecrow</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
